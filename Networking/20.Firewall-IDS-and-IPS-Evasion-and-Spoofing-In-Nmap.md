# Firewall-IDS-and-IPS-Evasion-and-Spoofing-in-Nmap

## Firewall, IDS, and IPS Evasion & Spoofing in Nmap

Nmap provides multiple techniques to bypass firewalls, Intrusion Detection Systems (IDS), and Intrusion Prevention Systems (IPS), aiding stealthy reconnaissance and penetration testing.

---

## Stateless vs Stateful Firewalls

### Stateless Firewalls:
Inspect packets independently by addresses and ports without tracking traffic state. Simple rule-sets may allow spoofed or fragmented packets.

### Stateful Firewalls:
Track entire communication sessions and TCP states (SYN, ACK, established). They can inspect packet sequences, fragmentation, and connection states.

---

## Common Nmap Evasion Techniques

### Fragmented Packets ( -f )
*Splits scan packets into small IP fragments making detection harder for simple packet inspectors.*

    nmap -f 192.168.1.208
    
    nmap -v -Pn -f 192.168.1.208
    
    nmap --mtu 16 192.168.1.1
    
    nmap -v -Pn --mtu 8 -p- 192.168.1.243


### Decoy Scanning ( -D )
*Sends scans from multiple fake IP addresses alongside the real scan to confuse logs and hide the real attacker's IP.*

    nmap -D 192.168.1.10,192.168.1.20,192.168.1.30 192.168.1.208
   
    nmap -D 192.168.1.10,192.168.1.20,192.168.1.30,192.168.1.7 192.168.1.1


# Firewall-IDS-and-IPS-Evasion-and-Spoofing-in-Nmap

## Firewall, IDS, and IPS Evasion & Spoofing in Nmap

Nmap provides multiple techniques to bypass firewalls, Intrusion Detection Systems (IDS), and Intrusion Prevention Systems (IPS), aiding stealthy reconnaissance and penetration testing.

---

## Stateless vs Stateful Firewalls

Both firewall types control network traffic but differ significantly in how they inspect and filter packets.

---

### Stateless Firewall

**How it Works:**
Examines each packet **individually** based solely on predefined rules such as source/destination IP, port number, and protocol. No memory of past packets or connection state.

**Features:**
- Simple, fast filtering based on static rules.
- Cannot track TCP session states or packet sequences.
- Effective at blocking or allowing traffic by IP or port.
- Susceptible to spoofing and fragmented packet evasion.
- Requires extensive, detailed rule sets.

**Advantages:**
- High speed and low resource consumption.
- Simple configuration and maintenance for basic filtering.
- Suitable for small networks or high-throughput environments.

**Limitations:**
- Cannot detect complex attacks like connection hijacking or certain DoS attacks.
- Ineffective against spoofed packets or dynamic port negotiations.
- Lacks context-aware filtering leading to potential security gaps.

---

### Stateful Firewall

**How it Works:**
Tracks and records the **state of active connections** (TCP streams, UDP flows) in a state table. Filters packets based on connection context — allowing packets only if they belong to valid sessions.

**Features:**
- Context-aware inspection of packet sequences and connection stages.
- Can differentiate between legitimate session traffic and illegitimate attempts.
- Supports more sophisticated security policies, e.g., blocking unsolicited packets or tracking fragmented packets.

**Advantages:**
- Stronger security due to connection state tracking.
- Can detect spoofing, session hijacking, and unauthorized traffic.
- Simplifies rule management with automatic return traffic allowances.
- Effective against a wider range of network attacks.

**Limitations:**
- More resource-intensive (CPU, memory) due to state tracking.
- Slightly slower than stateless firewalls under heavy load.
- Configuration complexity higher but improved with automated state management.

---

## Summary of Differences

| Aspect              | Stateless Firewall                              | Stateful Firewall                                   |
|---------------------|------------------------------------------------|-----------------------------------------------------|
| Packet Inspection   | Inspects each packet independently             | Tracks connection state and inspects packets in context |
| Connection Awareness| None                                           | Maintains state tables of active connections        |
| Security Level      | Basic filtering; vulnerable to spoofing        | Higher security; detects spoofing, hijacking        |
| Performance         | Faster, less resource-demanding                | Slightly slower, more resource-heavy                |
| Configuration       | Manual, extensive ACLs needed                  | Simpler rules with automatic connection tracking    |


## Common Nmap Evasion Techniques

# Packet Fragmentation in Nmap

## What is Fragmentation?
Network packets, including TCP/IP packets, can be broken into smaller pieces or fragments before being transmitted. Each fragment is sent separately and recombined by the destination.

## Why Fragment Packets?
- Some **firewalls and intrusion detection systems (IDS)** have trouble reassembling fragmented packets.
- Fragmenting packets can evade signature-based detection and content inspection that rely on inspecting full packets.
- Fragmentation can bypass simple packet filters that only examine initial fragments or the first few bytes.

## Fragmentation in Nmap
- Nmap can send **IP packets fragmented into smaller pieces** using the `-f` option or specifying a custom MTU (`--mtu`).
- By default, when `-f` is used, Nmap fragments packets into chunks of 8 bytes or less (after IP header).
- Sending fragmented probes makes it harder for some firewalls and IDS to detect scanning activity or block packets.

## Example Commands Using Fragmentation

- Basic fragmented scan

      nmap -f 192.168.1.208

- Verbose fragmented scan, skipping ping discovery

      nmap -v -Pn -f 192.168.1.208

- Fragmented scan with custom MTU (16 bytes)

      nmap --mtu 16 192.168.1.1

- Verbose no-ping fragmented scan on all ports

      nmap -v -Pn --mtu 8 -p- 192.168.1.243

- Fragmented scan with MTU 16 on port 80

      nmap -v -Pn --mtu 16 -p 80 192.168.1.40

# Limitations and Considerations
- Modern firewalls and IDS are generally more robust and **can handle fragmented packets** properly, making this evasion technique less effective today.
- Fragmented traffic may cause compatibility issues with some network devices or hosts.
- Overuse of fragmentation may raise suspicion or cause packet loss.

# Summary
Fragmentation (`-f` or `--mtu`) in Nmap is an **evasion technique** that splits scan packets into smaller fragments to evade packet inspection by less sophisticated firewalls or IDS. Although effective in certain scenarios, its success is decreasing as security devices improve.

## Decoy Scanning ( -D )

*Sends scans from multiple fake IP addresses alongside the real scan to confuse logs and hide the real attacker's IP.*

    nmap -D 192.168.1.10,192.168.1.20,192.168.1.30 192.168.1.151
    
    nmap -D 192.168.1.10,192.168.1.20,192.168.1.30,192.168.1.7 192.168.1.1



## Spoofing Source IP ( -S )

*Fakes the source IP address to bypass IP-based filtering.*

    nmap -S 192.168.1.100 192.168.1.1
    
    nmap -v -Pn -p- 192.168.1.1 -e eth0 -S 192.168.1.200


**Note:** Requires direct network access and proper routing.

## Spoofing MAC Address ( --spoof-mac )

*Changes MAC address to evade detection or impersonate trusted devices.*
    
    nmap --spoof-mac 00:11:22:33:44:55 192.168.1.1
   
    nmap -v -Pn 192.168.1.40 --spoof-mac cisco


## Randomizing Source Port ( -g or --source-port )

*Sets source port to commonly allowed ports (e.g., 53 for DNS) to evade basic filtering.*

    nmap -g 53 192.168.1.1
  
## Scanning Through Proxies ( --proxies )

*Routes scan traffic via HTTP/SOCKS proxies to hide the scan origin.*

    nmap --proxies http://proxy-example.com:8080 192.168.1.161


## Idle Scan ( -sI )

*Uses a "zombie" host to relay scan packets, keeping the real scanner completely hidden.*

    nmap -sI 192.168.1.50 192.168.1.1


## Randomizing Scan Order ( --randomize-hosts )

*Scans hosts in randomized order instead of sequentially, to make pattern detection harder.*

    nmap --randomize-hosts 192.168.1.0/24
    
    nmap --randomize-hosts -p 30 192.168.1.0/24


## Cloaking Nmap Signature ( --data-length )

*Appends random data payloads to each packet to confuse signature-based IDS.*

    nmap --data-length 50 192.168.1.1
   
    nmap -v -Pn --data-length 128 192.168.1.151 -p 80
    
    nmap -Pn 192.168.1.151 -p 80 --data 41414141414141
    
    nmap -Pn 192.168.1.151 -p 80 --data 4142434445
    
    nmap -Pn 192.168.1.151 -p 80 --data-string armour

## Avoiding Ping ( -Pn )

*Skips host discovery (ping) useful when ICMP is blocked but TCP/UDP traffic is allowed.*

    nmap -Pn 192.168.1.1

# Nmap-Scripting-Engine(NSE)–Script-Scan

## Nmap Scripting Engine (NSE) – Script Scan (-sC or --script)

The **Nmap Scripting Engine (NSE)** enhances Nmap's scanning capabilities by automating various tasks such as discovery, version detection, vulnerability scanning, brute-forcing, and more.

Scripts are written in **Lua**, allowing flexibility and extensibility.

---

## Basic Usage and Syntax

### Run default scripts (equivalent to --script=default):

    nmap -sC <target>


### Run specific script(s):

    nmap --script <script-name> <target>
 
    nmap --script <script1,script2,...> <target>


### Run scripts by category:

    nmap --script <category> <target>


### Use wildcards or expressions:

    nmap --script "http-" <target>
    
    nmap --script "smb" <target>
    
    nmap --script "default and not intrusive" <target>


### Run custom script file:

    nmap --script /path/to/custom-script.nse <target>


### Example full scan with default scripts and common options:

    nmap -v -Pn -sT -sV -A -O -p- --script=default 192.168.1.208
   
    nmap -v -Pn -sT -sV -A -O -p- --script=default 192.168.1.151

## Managing and Finding NSE Scripts

### List all scripts:

    ls /usr/share/nmap/scripts/
   
    ls /usr/share/nmap/scripts/ | wc -l


### Update script database:

    nmap --script-updatedb


### Explore scripts by keyword:

    grep smb /usr/share/nmap/scripts/script.db
  
    ls /usr/share/nmap/scripts/ | grep ftp
    
    ls /usr/share/nmap/scripts/ | grep http


---

## NSE Script Categories

| Category    | Description                                      |
|-------------|--------------------------------------------------|
| auth        | Authentication bypass, brute-force attacks        |
| broadcast   | Network discovery via broadcast                   |
| brute       | Brute-force login attempts                        |
| discovery   | Host, service, and configuration discovery        |
| dos         | Denial-of-Service testing                         |
| exploit     | Exploit known vulnerabilities                     |
| external    | Leverage external services (e.g., WHOIS, Shodan)  |
| fuzzer      | Send unexpected data for robustness testing       |
| intrusive   | May affect targets or trigger alerts              |
| malware     | Detect malware-infected hosts                     |
| safe        | No attack or disruption; safe scans               |
| version     | Enhance version detection                        |
| vuln        | Vulnerability detection                           |
| default     | A curated set of useful scripts (various categories) |
| scada       | SCADA/ICS industrial control systems testing      |


## Common and Useful Scripts

| Script Name        | Purpose                                             | Example Command      |
|--------------------|-----------------------------------------------------|----------------------|
| ftp-anon           | Checks for anonymous FTP login                      | nmap -v -p 21 --script=ftp-anon.nse 192.168.1.35 |
| smb-brute          | SMB brute force login                               | nmap -v -p 445 --script=smb-brute 192.168.1.50   |
| ssh-brute          | SSH password brute force                            | nmap -p 22 --script ssh-brute --script-args userdb=usr,passdb=pass 192.168.1.40 |
| http-methods       | Enumerates HTTP methods                             | nmap -v -p 80 --script=http-methods 192.168.1.35 |
| http-robots.txt    | Checks and parses robots.txt file                   | nmap -v -Pn -sT -sV --script=http-robots.txt.nse -p 443 example.com |
| smb-vuln-ms17-010  | Checks SMB vulnerability (EternalBlue)              | nmap -v -p 445 --script=smb-vuln-ms17-010.nse 192.168.1.15 |
| vuln               | Runs multiple vulnerability detection scripts        | nmap -v -sT --script=vuln 192.168.1.15          |
| modbus-discover    | Enumerates Modbus SCADA devices                      | nmap -v -Pn -sT -sV -A -O -p- --script=scada 192.168.1.208 |

## Running Multiple or Complex Script Commands

### Multiple specific scripts:

    nmap --script "ssh-brute,ftp-brute,smb-brute" 192.168.1.208


### Using wildcards:

    nmap --script "http-*" 192.168.1.208


### Exclude certain scripts:

    nmap --script "default and not intrusive" 192.168.1.208


### Based on regex patterns:

    nmap --script "^(smb|ftp|...)" 192.168.1.208

## Summary Table of Script Expression Usage

| Expression                      | Function                                     |
|----------------------------------|----------------------------------------------|
| --script "ftp-anon"              | Run single script                            |
| --script "ssh-brute,ftp-brute"   | Run multiple scripts                         |
| --script "http-*"                | Run all HTTP-related scripts                 |
| --script "vuln"                  | Run vulnerability detection scripts          |
| --script "*smb*"                 | Run all SMB-related scripts                  |
| --script "not safe"              | Exclude safe scripts                         |
| --script "discovery and not intrusive" | Run discovery scripts excluding intrusive ones |
| --script "brute or vuln"         | Run brute-force and vulnerability scripts    |
| --script "http-title" -vv        | Run script with verbose output               |

---

## Tips and Best Practices

- Use **-sC** for a quick scan with default beneficial scripts.
- Select scripting categories to focus on areas of interest (e.g., **--script=vuln** for vulnerabilities).
- Combine with version detection (**-sV**) and OS detection (**-O**) for thorough assessments.
- Regularly update Nmap and scripts to gain latest detection capabilities.
- Use verbose (**-v** or **-vv**) to get detailed script execution output.


