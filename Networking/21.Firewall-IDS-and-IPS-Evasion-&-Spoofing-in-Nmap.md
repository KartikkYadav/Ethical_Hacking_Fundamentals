# Firewall, IDS, and IPS Evasion & Spoofing in Nmap

Nmap provides multiple techniques to bypass firewalls, Intrusion Detection Systems (IDS), and Intrusion Prevention Systems (IPS), aiding stealthy reconnaissance and penetration testing.

## Stateless vs Stateful Firewalls

Both firewall types control network traffic but differ significantly in how they inspect and filter packets.

---

## Stateless Firewall

**How it Works:**  
Examines each packet **individually** based solely on predefined rules such as source/destination IP, port number, and protocol. No memory of past packets or connection state.

### Features:
- Simple, fast filtering based on static rules.
- Cannot track TCP session states or packet sequences.
- Effective at blocking or allowing traffic by IP or port.
- Susceptible to spoofing and fragmented packet evasion.
- Requires extensive, detailed rule sets.

### Advantages:
- High speed and low resource consumption.
- Simple configuration and maintenance for basic filtering.
- Suitable for small networks or high-throughput environments.

### Limitations:
- Cannot detect complex attacks like connection hijacking or certain DoS attacks.
- Ineffective against spoofed packets or dynamic port negotiations.
- Lacks context-aware filtering leading to potential security gaps.

---

## Stateful Firewall

**How it Works:**  
Tracks and records the **state of active connections** (TCP streams, UDP flows) in a state table. Filters packets based on connection contextâ€”allowing packets only if they belong to valid sessions.

### Features:
- Context-aware inspection of packet sequences and connection stages.
- Can differentiate between legitimate session traffic and illegitimate attempts.
- Supports more sophisticated security policies (e.g., blocking unsolicited packets or tracking fragmented packets).

### Advantages:
- Stronger security due to connection state tracking.
- Can detect spoofing, session hijacking, and unauthorized traffic.
- Simplifies rule management with automatic return traffic allowances.
- Effective against a wider range of network attacks.

### Limitations:
- More resource-intensive (CPU, memory) due to state tracking.
- Slightly slower than stateless firewalls under heavy load.
- Configuration complexity higher but improved with automated state management.

---

## Summary of Differences

| Aspect                | Stateless Firewall                                      | Stateful Firewall                               |
|-----------------------|--------------------------------------------------------|-------------------------------------------------|
| Packet Inspection     | Inspects each packet independently                     | Tracks connection state and inspects packets in context |
| Connection Awareness  | None                                                   | Maintains state tables of active connections     |
| Security Level        | Basic filtering; vulnerable to spoofing                | Higher security; detects spoofing, hijacking     |
| Performance           | Faster, less resource-demanding                        | Slightly slower, more resource-heavy             |
| Configuration         | Manual, extensive ACLs needed                          | Simpler rules with automatic connection tracking |
| Use Cases             | Basic filtering, routers, high-throughput              | Enterprise/firewall security, VPN gateways       |

---

## Typical Use Cases

- **Stateless Firewall:**  
  Suitable for simple perimeter filtering, small networks, devices with limited resources, or environments prioritizing speed.

- **Stateful Firewall:**  
  Ideal for enterprise networks, data centers, or security-sensitive environments requiring granular traffic control and attack detection.

---

## Additional Insights

- Stateful firewalls operate mainly at OSI Layers 3 and 4, allowing context-aware decisions.
- They can detect and mitigate network attacks relying on connection patterns that stateless firewalls miss.
- Stateless filters work well when performance is crucial but provide less protection.

---

## Common Nmap Evasion Techniques

# Packet Fragmentation in Nmap

## What is Fragmentation?
Network packets, including TCP/IP packets, can be broken into smaller pieces or **fragments** before being transmitted. Each fragment is sent separately and recombined by the destination.

## Why Fragment Packets?
- Some **firewalls and intrusion detection systems (IDS)** have trouble reassembling fragmented packets.
- Fragmenting packets can evade signature-based detection and content inspection that rely on inspecting full packets.
- Fragmentation can bypass simple packet filters that only examine initial fragments or the first few bytes.

## Fragmentation in Nmap
- Nmap can send **IP packets fragmented into smaller pieces** using the `-f` option or specifying a custom MTU (`--mtu`).
- By default, when `-f` is used, Nmap fragments packets into chunks of 8 bytes or less (after IP header).
- Sending fragmented probes makes it harder for some firewalls and IDS to detect scanning activity or block packets.

## Example Commands Using Fragmentation

- Basic fragmented scan

      nmap -f 192.168.1.208

- Verbose fragmented scan, skipping ping discovery

      nmap -v -Pn -f 192.168.1.208

- Fragmented scan with custom MTU (16 bytes)

      nmap --mtu 16 192.168.1.1

- Verbose no-ping fragmented scan on all ports

      nmap -v -Pn --mtu 8 -p- 192.168.1.243
