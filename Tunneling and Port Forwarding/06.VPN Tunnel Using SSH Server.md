# VPN Tunnel Using SSH Server (TUN/TAP)

This setup demonstrates how to create a **VPN-like tunnel using SSH** with **TUN interfaces**.

> **Note**
- Root access is required on both attacker and target systems  
- SSH must allow tunneling

---

## 1. Prerequisites

- Root access on both systems  
- SSH service running on target  
- SSH server must allow:
  - Root login
  - Tunnel interfaces

---

## 2. Lab Scenario

### Network Layout

| Role | System | IP |
|-----|--------|----|
| Attacker | Kali Linux | 192.168.2.233 |
| Target | SSH Server | 192.168.2.253 |
| Internal Web Server | Target LAN | 192.168.3.250:80 |

---

## 3. SSH Server Configuration (Target)

Edit SSH daemon configuration:

    vim /etc/ssh/sshd_config

- Enable the following options:

      PermitRootLogin yes
      PermitTunnel yes

- Restart SSH service:

      systemctl restart ssh

## 4. Create SSH Tunnel (Attacker)
Run as root on attacker machine.

### Check existing TUN interfaces

      ifconfig -a

- Create the SSH tunnel

      ssh root@192.168.2.253 -w any:any

This creates a TUN interface on both attacker and target systems.

### Verify tunnel creation

    ifconfig -a

### 5. CONFIGURE Tunnel Interfaces

    ip addr add 192.168.3.50/24 peer 192.168.3.51 dev tun0
    ip link set tun0 up

### Target Side (SSH Server)

    ip addr add 192.168.3.51/24 peer 192.168.3.50 dev tun0
    ip link set tun0 up

### 6. Enable IP Forwarding and NAT (Target)
Enable IP Forwarding (Temporary)

    echo 1 > /proc/sys/net/ipv4/ip_forward

#### Enable IP Forwarding (Persistent)

    sysctl -w net.ipv4.ip_forward=1

#### Configure NAT
(Adjust interface name if needed)

    iptables -t nat -A POSTROUTING -s 192.168.3.50 -o enp0s8 -j MASQUERADE

### 7. Add Route (Attacker)
Route traffic for internal network through tunnel:

    ip route add 192.168.3.0/24 via 192.168.3.51

### 8. Traffic Flow

    Attacker (192.168.2.233)
      ↓
    tun0 (192.168.3.50)
      ↓
    Target tun0 (192.168.3.51)
      ↓ [IP Forwarding + NAT]
    Target LAN (192.168.3.0/24)
      ↓
    Web Server (192.168.3.250:80)

### 9. Result

- SSH-based Layer-3 VPN tunnel established
- Full access to 192.168.3.0/24
- Internal services reachable (e.g. 192.168.3.250:80)

### 10. Rollback / Cleanup
Stop SSH Tunnel
On attacker machine:

    Ctrl + C

### 11. Bring Down Tunnel Interfaces
Attacker

    ip link set tun0 down

### Target

    ip link set tun0 down

### 12. Remove Tunnel IP Addresses
Attacker

    ip addr del 192.168.3.50/24 dev tun0

### Target

    ip addr del 192.168.3.51/24 dev tun0

### 13. Remove Route (Attacker)

    ip route del 192.168.3.0/24 via 192.168.3.51

Verify:

    ip route

### 14. Disable IP Forwarding (Target)
Temporary

    echo 0 > /proc/sys/net/ipv4/ip_forward

Persistent

    sysctl -w net.ipv4.ip_forward=0

Verify:

    cat /proc/sys/net/ipv4/ip_forward

Expected output:

    0

### 15. Remove NAT Rule (Target)
Delete by Exact Rule

    iptables -t nat -D POSTROUTING -s 192.168.3.50 -o enp0s8 -j MASQUERADE

OR Delete by Rule Number

    iptables -t nat -L POSTROUTING -n -v --line-numbers
    iptables -t nat -D POSTROUTING <RULE_NUMBER>

### 16. Verify Cleanup
Check tunnel interfaces:

    ip link show | grep tun

Expected result:

    (no output)

Check NAT table:

    iptables -t nat -L POSTROUTING -n -v

### 17. Restore SSH Hardening (Recommended)
Edit SSH configuration:

    vim /etc/ssh/sshd_config

Revert settings:

    PermitRootLogin no
    PermitTunnel no
